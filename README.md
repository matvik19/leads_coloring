# Виджет окраски сделок AmoCRM

## Описание

Микросервис для автоматической окраски сделок в AmoCRM на основе настраиваемых правил. Позволяет пользователям создавать правила с условиями и применять к подходящим сделкам цветовое выделение (текст + фон).

## Бизнес-логика

### Основная концепция

1. **Правила окраски** - пользователь создает правила с условиями и стилями
2. **Условия** - набор проверок полей сделки (бюджет > 100000, статус = "Новая" и т.д.)
3. **Приоритет** - правила применяются по приоритету (от высшего к низшему)
4. **Применение** - для каждой сделки применяется только первое подходящее правило
5. **Изоляция** - правила изолированы по аккаунтам AmoCRM (subdomain)

### Как это работает

```
1. Пользователь создает правило:
   - Название: "VIP клиенты"
   - Условие: Бюджет > 100000 И Статус = "Новая"
   - Стиль: Красный фон, белый текст
   - Приоритет: 1

2. Виджет в AmoCRM запрашивает стили для сделок:
   - Отправляет IDs сделок: [123, 456, 789]

3. Бэкенд проверяет каждую сделку:
   - Получает данные сделки из AmoCRM
   - Проверяет правила по приоритету
   - Возвращает стили для подходящих сделок

4. Виджет применяет стили:
   - Сделка 123: красный фон (подходит под правило)
   - Сделка 456: без окраски (не подходит)
   - Сделка 789: красный фон (подходит под правило)
```

---

## API Endpoints (через RabbitMQ)

> **Важно:** Все операции выполняются через RabbitMQ очереди, а не HTTP endpoints.

### 1. Получение полей сделок

**Назначение:** Получить список всех доступных полей сделки для создания условий в правилах.

**Очередь:** `leads_coloring_deal_fields`

**Входные данные:**
```json
{
  "subdomain": "example"
}
```

**Возвращает:**
```json
{
  "success": true,
  "fields": [
    {
      "id": "name",
      "name": "Название",
      "type": "string"
    },
    {
      "id": "price",
      "name": "Бюджет",
      "type": "number"
    },
    {
      "id": "status_id",
      "name": "Статус",
      "type": "enum"
    },
    {
      "id": "pipeline_id",
      "name": "Воронка",
      "type": "enum"
    },
    {
      "id": "responsible_user_id",
      "name": "Ответственный",
      "type": "enum"
    },
    {
      "id": "created_at",
      "name": "Дата создания",
      "type": "date"
    },
    {
      "id": "updated_at",
      "name": "Дата изменения",
      "type": "date"
    },
    {
      "id": "closed_at",
      "name": "Дата закрытия",
      "type": "date"
    }
  ]
}
```

**Типы полей:**
- `string` - текстовые поля (название, комментарий)
- `number` - числовые поля (бюджет, количество)
- `date` - поля даты (дата создания, дедлайн)
- `enum` - выбор из списка (статус, воронка, менеджер)
- `boolean` - да/нет (чекбоксы)

**Примечание:** Список содержит как стандартные поля AmoCRM, так и кастомные поля аккаунта.

---

### 2. Создание правила

**Назначение:** Создать новое правило окраски сделок.

**Очередь:** `leads_coloring_rules_create`

**Входные данные:**
```json
{
  "subdomain": "example",
  "name": "VIP клиенты",
  "is_active": true,
  "priority": 1,
  "conditions": {
    "type": "AND",
    "rules": [
      {
        "field": "price",
        "operator": ">",
        "value": 100000
      },
      {
        "field": "status_id",
        "operator": "==",
        "value": 142
      }
    ]
  },
  "style": {
    "text_color": "#FFFFFF",
    "background_color": "#FF0000"
  }
}
```

**Параметры:**
- `subdomain` - субдомен AmoCRM (обязательно)
- `name` - название правила (обязательно)
- `is_active` - активно ли правило (по умолчанию: true)
- `priority` - приоритет правила, чем выше число - тем выше приоритет (по умолчанию: 0)
- `conditions` - условия применения правила (обязательно)
  - `type` - логический оператор: `"AND"` (И) или `"OR"` (ИЛИ)
  - `rules` - массив условий
    - `field` - ID поля из списка полей
    - `operator` - оператор сравнения (см. таблицу операторов ниже)
    - `value` - значение для сравнения
- `style` - стили окраски (обязательно)
  - `text_color` - цвет текста в формате HEX (#FFFFFF)
  - `background_color` - цвет фона в формате HEX (#FF0000)

**Возвращает:**
```json
{
  "success": true,
  "id": 1
}
```

---

### Операторы сравнения

**Для текстовых полей (string):**
| Оператор | Описание | Пример |
|----------|----------|--------|
| `==` | Равно (точное совпадение) | Название = "VIP Клиент" |
| `!=` | Не равно | Название ≠ "Тестовая" |
| `contains` | Содержит | Комментарий содержит "срочно" |
| `not_contains` | Не содержит | Комментарий не содержит "отмена" |
| `starts_with` | Начинается с | Название начинается с "VIP" |
| `ends_with` | Заканчивается на | Название заканчивается на "2024" |
| `is_empty` | Пустое | Комментарий пустой |
| `is_not_empty` | Не пустое | Описание не пустое |

**Для числовых полей (number):**
| Оператор | Описание | Пример |
|----------|----------|--------|
| `==` | Равно | Бюджет = 100000 |
| `!=` | Не равно | Бюджет ≠ 50000 |
| `>` | Больше | Сумма > 50000 |
| `<` | Меньше | Бюджет < 200000 |
| `>=` | Больше или равно | Количество ≥ 10 |
| `<=` | Меньше или равно | Вес ≤ 100 |
| `between` | Между | Бюджет между 50000 и 200000 |
| `is_empty` | Пустое | Бюджет пустой |
| `is_not_empty` | Не пустое | Сумма не пустая |

**Для полей даты (date):**
| Оператор | Описание | Пример |
|----------|----------|--------|
| `==` | Равно | Дата создания = 15.01.2024 |
| `!=` | Не равно | Дедлайн ≠ 20.01.2024 |
| `>` | После даты | Дата завершения после 01.01.2024 |
| `<` | До даты | Дедлайн до 31.12.2024 |
| `between` | Между датами | Дата создания между 01.01-31.01.2024 |
| `today` | Сегодня | Дата создания сегодня |
| `yesterday` | Вчера | Дата создания вчера |
| `this_week` | На этой неделе | Дедлайн на этой неделе |
| `last_week` | На прошлой неделе | Дата на прошлой неделе |
| `this_month` | В этом месяце | В этом месяце |
| `last_month` | В прошлом месяце | В прошлом месяце |
| `last_n_days` | За последние N дней | Дата создания за последние 7 дней |
| `is_empty` | Не указана | Дата не указана |
| `is_not_empty` | Указана | Дата указана |

**Для выбора из списка (enum):**
| Оператор | Описание | Пример |
|----------|----------|--------|
| `==` | Равно | Статус = "Успешно реализовано" |
| `!=` | Не равно | Ответственный ≠ "Иванов" |
| `in` | В списке | Источник в (сайт, реклама, соцсети) |
| `not_in` | Не в списке | Тип клиента не в (физлицо, ип) |
| `is_empty` | Не выбрано | Не выбрано |
| `is_not_empty` | Выбрано | Выбрано |

**Для чекбоксов (boolean):**
| Оператор | Описание | Пример |
|----------|----------|--------|
| `==` | Равно | Есть договор = Да |

---

### 3. Обновление правила

**Назначение:** Обновить существующее правило.

**Очередь:** `leads_coloring_rules_update`

**Входные данные:**
```json
{
  "rule_id": 1,
  "subdomain": "example",
  "name": "VIP клиенты (обновлено)",
  "is_active": false,
  "priority": 2,
  "conditions": {
    "type": "OR",
    "rules": [
      {
        "field": "price",
        "operator": ">",
        "value": 200000
      }
    ]
  },
  "style": {
    "text_color": "#000000",
    "background_color": "#FFD700"
  }
}
```

**Возвращает:**
```json
{
  "success": true,
  "id": 1
}
```

---

### 4. Получение списка правил

**Назначение:** Получить все правила для аккаунта.

**Очередь:** `leads_coloring_rules_list`

**Входные данные:**
```json
{
  "subdomain": "example"
}
```

**Возвращает:**
```json
{
  "success": true,
  "rules": [
    {
      "id": 1,
      "name": "VIP клиенты",
      "is_active": true,
      "priority": 1,
      "conditions": {
        "type": "AND",
        "rules": [
          {
            "field": "price",
            "operator": ">",
            "value": 100000
          }
        ]
      },
      "style": {
        "text_color": "#FFFFFF",
        "background_color": "#FF0000"
      },
      "created_at": "2024-01-01T00:00:00Z",
      "updated_at": "2024-01-01T00:00:00Z"
    }
  ]
}
```

---

### 5. Удаление правила

**Назначение:** Удалить правило.

**Очередь:** `leads_coloring_rules_delete`

**Входные данные:**
```json
{
  "rule_id": 1,
  "subdomain": "example"
}
```

**Возвращает:**
```json
{
  "success": true
}
```

---

### 6. Изменение приоритетов правил

**Назначение:** Изменить порядок применения правил (перетаскивание в интерфейсе).

**Очередь:** `leads_coloring_priorities_update`

**Входные данные:**
```json
{
  "subdomain": "example",
  "priorities": [
    {"id": 1, "priority": 3},
    {"id": 2, "priority": 1},
    {"id": 3, "priority": 2}
  ]
}
```

**Возвращает:**
```json
{
  "success": true
}
```

---

### 7. Получение стилей для сделок (для виджета)

**Назначение:** Получить стили окраски для списка сделок. Используется виджетом для визуализации.

**Очередь:** `leads_coloring_leads_styles`

**⚠️ ВАЖНО:** Фронт может использовать терминологию "deals" (сделки), но бэкенд работает с "leads". В AmoCRM это синонимы.

**Входные данные:**
```json
{
  "subdomain": "example",
  "lead_ids": [123, 456, 789]
}
```

**Возвращает:**
```json
{
  "success": true,
  "styles": {
    "123": {
      "text_color": "#FFFFFF",
      "background_color": "#FF0000",
      "matched_rule_id": 1,
      "matched_rule_name": "VIP клиенты"
    },
    "789": {
      "text_color": "#000000",
      "background_color": "#FFFF00",
      "matched_rule_id": 2,
      "matched_rule_name": "Новые сделки"
    }
  }
}
```

**Примечание:**
- Возвращаются **только** сделки, которые подходят под правила
- Сделка 456 отсутствует в ответе - значит не подходит ни под одно правило
- Для каждой сделки применяется **только первое** подходящее правило по приоритету

**Алгоритм:**
1. Получить активные правила для subdomain (отсортированы по приоритету)
2. Получить данные сделок из AmoCRM API (токен получается автоматически через RPC)
3. Для каждой сделки:
   - Проверить правила по приоритету (от высшего к низшему)
   - При первом совпадении - применить стиль и перейти к следующей сделке
   - Если ни одно правило не подошло - сделка не попадает в ответ

---

### 8. Тестирование правила

**Назначение:** Проверить, подходит ли сделка под условия правила. Используется для отладки при создании правил.

**Очередь:** `leads_coloring_rules_test`

**Входные данные:**
```json
{
  "conditions": {
    "type": "AND",
    "rules": [
      {
        "field": "price",
        "operator": ">",
        "value": 100000
      }
    ]
  },
  "lead_data": {
    "price": 150000,
    "status_id": 142,
    "name": "Тестовая сделка"
  }
}
```

**Возвращает:**
```json
{
  "success": true,
  "matches": true,
  "details": "Условие выполнено"
}
```

---

### 9. Health Check

**Назначение:** Проверка работоспособности сервиса.

**Очередь:** `leads_coloring_health`

**Входные данные:**
```json
{}
```

**Возвращает:**
```json
{
  "status": "ok",
  "service": "leads-coloring"
}
```

---

## Обработка ошибок

Все ошибки возвращаются в формате:

```json
{
  "success": false,
  "error": "Описание ошибки"
}
```

**Примеры ошибок:**
- `"subdomain is required"` - не указан субдомен
- `"Invalid tokens received from token service"` - ошибка получения токенов
- `"Rule not found"` - правило не найдено
- `"Failed to fetch leads: ..."` - ошибка получения данных из AmoCRM

---

## Примеры использования

### Пример 1: Окраска VIP клиентов

**Цель:** Все сделки с бюджетом > 100000 красить красным.

```json
{
  "subdomain": "mycrm",
  "name": "VIP клиенты",
  "is_active": true,
  "priority": 10,
  "conditions": {
    "type": "AND",
    "rules": [
      {
        "field": "price",
        "operator": ">",
        "value": 100000
      }
    ]
  },
  "style": {
    "text_color": "#FFFFFF",
    "background_color": "#FF0000"
  }
}
```

### Пример 2: Окраска по статусу и менеджеру

**Цель:** Новые сделки конкретного менеджера красить желтым.

```json
{
  "subdomain": "mycrm",
  "name": "Новые сделки Иванова",
  "is_active": true,
  "priority": 5,
  "conditions": {
    "type": "AND",
    "rules": [
      {
        "field": "status_id",
        "operator": "==",
        "value": 142
      },
      {
        "field": "responsible_user_id",
        "operator": "==",
        "value": 123456
      }
    ]
  },
  "style": {
    "text_color": "#000000",
    "background_color": "#FFFF00"
  }
}
```

### Пример 3: Окраска сделок без бюджета ИЛИ старых сделок

**Цель:** Сделки без бюджета или созданные более 30 дней назад красить серым.

```json
{
  "subdomain": "mycrm",
  "name": "Проблемные сделки",
  "is_active": true,
  "priority": 1,
  "conditions": {
    "type": "OR",
    "rules": [
      {
        "field": "price",
        "operator": "is_empty",
        "value": null
      },
      {
        "field": "created_at",
        "operator": "last_n_days",
        "value": 30
      }
    ]
  },
  "style": {
    "text_color": "#666666",
    "background_color": "#CCCCCC"
  }
}
```

---

## Технологический стек

- **FastStream** (RabbitMQ) - обработка сообщений из очередей
- **PostgreSQL** - хранение правил
- **SQLAlchemy** + **Alembic** - ORM и миграции БД
- **aiohttp** - асинхронные HTTP запросы к AmoCRM API
- **Pydantic** - валидация данных
- **RPC** - автоматическое получение токенов из сервиса токенов

---

## Запуск

### FastStream Worker
```bash
cd src
faststream run app.broker_app:app --workers 1
```

### Переменные окружения
```bash
# RabbitMQ
RABBITMQ_HOST=broker
RABBITMQ_PORT=5672
RABBITMQ_USER=guest
RABBITMQ_PASS=guest
RABBITMQ_VHOST=/

# PostgreSQL
DB_HOST=localhost
DB_PORT=5432
DB_USER=postgres
DB_PASSWORD=password
DB_DATABASE=leads_coloring

# AmoCRM
AMOCRM_CLIENT_ID=your_client_id
AMOCRM_CLIENT_SECRET=your_secret
AMOCRM_REDIRECT_URL=your_redirect_url
AMOCRM_RATE_LIMIT=6.0

# Worker
WORKER_WORKERS=1
WORKER_PREFETCH_COUNT=10
```

---

## Требования и ограничения

1. **Изоляция по аккаунтам:** Все правила и данные изолированы по `subdomain`
2. **Приоритет правил:** Применяется только первое подходящее правило
3. **Активные правила:** Правила с `is_active: false` игнорируются
4. **Валидация:** Все условия валидируются на бекенде
5. **Токены:** Автоматическое получение access token через сервис токенов (RPC)
6. **Кеширование:** Токены кешируются локально на 50 минут
7. **Логирование:** Все операции логируются с контекстом (subdomain, request_id)

---

## Соответствие фронтенду

### ✅ Полное соответствие:
- Все операции CRUD для правил
- Получение полей сделок
- Изменение приоритетов
- Тестирование правил
- Получение стилей для сделок

### ⚠️ Незначительные отличия:

**1. Терминология: leads vs deals**
- **Фронт ожидает:** `deal_ids`, `/api/deals/styles`
- **Бэк использует:** `lead_ids`, `leads_coloring_leads_styles`
- **Решение:** В AmoCRM "leads" = "сделки", это синонимы. Фронт должен использовать `lead_ids`.

**2. Формат доступа: HTTP vs RabbitMQ**
- **Фронт ожидает:** HTTP endpoints (GET /api/rules, POST /api/rules, etc.)
- **Бэк использует:** RabbitMQ очереди
- **Решение:** Фронт должен отправлять сообщения в RabbitMQ очереди, либо нужен API Gateway для преобразования HTTP → RabbitMQ.

**3. Access Token**
- **Фронт может передавать:** `access_token` в запросах
- **Бэк:** Получает токены автоматически через RPC, не требует `access_token` в запросах
- **Решение:** Фронт не должен передавать `access_token`, только `subdomain`.

---

## Дополнительная документация

- `MIGRATION_FASTSTREAM.md` - Документация по миграции на FastStream
- `src/alembic/` - Миграции базы данных
